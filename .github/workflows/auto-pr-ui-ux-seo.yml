name: Auto PR for UI/UX/SEO

on:
  push:
    branches:
      - ui-ux-seo
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  BASE_BRANCH: main
  HEAD_BRANCH: ui-ux-seo

jobs:
  create-update-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes versus main
        id: diff
        run: |
          git fetch origin "$BASE_BRANCH"
          if git diff --quiet "origin/$BASE_BRANCH"...HEAD; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Exit when no changes are present
        if: steps.diff.outputs.has_changes != 'true'
        run: echo "No differences to merge."

      # FIXED: This step now exposes pr.outputs.number
      - name: Create or reuse pull request
        if: steps.diff.outputs.has_changes == 'true'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_number=$(gh pr list \
            --head "$HEAD_BRANCH" \
            --base "$BASE_BRANCH" \
            --state open \
            --json number \
            --jq '.[0].number')

          if [ -z "$pr_number" ]; then
            gh pr create \
              --head "$HEAD_BRANCH" \
              --base "$BASE_BRANCH" \
              --title "UI/UX/SEO updates" \
              --fill

            pr_number=$(gh pr list \
              --head "$HEAD_BRANCH" \
              --base "$BASE_BRANCH" \
              --state open \
              --json number \
              --jq '.[0].number')
          else
            echo "PR already exists: #$pr_number"
          fi

          echo "number=$pr_number" >> "$GITHUB_OUTPUT"

      # Best-practice auto-merge
      - name: Enable auto-merge (squash)
        if: steps.diff.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ steps.pr.outputs.number }} \
            --squash \
            --auto
